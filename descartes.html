<!doctype html>
<script src="./descartes.js"></script>
<link rel=stylesheet href="./descartes.css">
<!-- <script src="https://d3js.org/d3.v3.min.js"></script> -->
<script src="https://d3js.org/d3.v4.min.js"></script>
<style>
  .link {
  stroke: #aaa;
  stroke-width: 1.5px;
}

.arrow {
  fill: #888;
}

circle {
  stroke: none;
}

circle.no-deps {
  stroke-width: 2;
  stroke-dasharray: 0 4 0;
  stroke: black;
}

.node {
  cursor: move;
  fill: #ccc;
  stroke: #000;
  stroke-width: 1.5px;
}
text {
  font-family: 'SF Mono', Menlo, monospace;
  font-weight: 400;
}
text.background {
  stroke: white;
  stroke-width: 3;
}
text.foreground {
  stroke: none;
  fill: #000;

}

.node.fixed {
  fill: #f00;
}
body {
  font-family: system-ui, "SF Pro Text", "SF Pro Icons", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
  font-weight: 200;
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  margin: 0;
  padding: 0;
}
#graph {

}

#main {
  flex: 1;
  overflow: auto;
}

.moduleName {
  font-weight: 200;
  font-size: 12px;
  padding: 4px 0;
  color: #4196cc;
  font-family: system-ui;
}

.item {
  padding: 16px 8px;
}

pre {
  margin: 0;
}

</style>
<body>
  <div id="graph"></div>
  <div id="main"></div>
  <script>
    (function() {

      var node = (tag, attrs, children) => {
        var node = document.createElement(tag)
        for (var attr in attrs) {
          if (attr === 'style') {
            Object.assign(node.style, attrs[attr])
          } else {
            node.setAttribute(attr, attrs[attr])
          }
        }
        children && children.forEach(child => child && node.appendChild(typeof child === 'string' ? document.createTextNode(child) : child))
        return node
      }
      var named = tag => (attrs, children) => node(tag, attrs, children)
      var div = named('div')
      var span = named('span')
      var a = named('a')
      var raw = (text, tag='div') => {
        var node = document.createElement(tag)
        node.innerHTML = text
        return node
      };

      var render = (target, node) => {
        target.innerHTML = ''
        target.appendChild(node)
      };

      var root = document.getElementById('main')

      render(root, div({}, Object.keys(DATA).map(k => {
        return div({class: 'item' + (DATA[k].values.length === 0 ? ' isolated' : ''), id: 'block-' + k}, [
          div({class: 'moduleName'}, [DATA[k].moduleName]),
          node('pre', {class: 'code'}, [raw(DATA[k].html, 'code')]),
          DATA[k].values.length ? div({class: 'uses'}, DATA[k].values.map(({id, name, moduleName}) => (
            div({class: 'use', 'data-global-use': id}, [moduleName + "." + name])
          ))) : null
        ])
      })))

      root.addEventListener('click', evt => {
        var id = evt.target.getAttribute('data-global-use')
        if (id) {
          window.location.hash = '#block-' + id
        }
      })

    })();
  </script>

  <script>
    (function() {

      var width = window.innerWidth,
          height = 500;

      var svg = d3.select("#graph").append("svg")
          .attr("width", width)
          .attr("height", height);

      svg.append("rect")
        .attr("width", width)
        .attr("height", height)
        .style("fill", "none")
        .style("pointer-events", "all")
        .call(d3.zoom()
            .scaleExtent([1 / 8, 4])
            .on("zoom", zoomed));

      var g = svg.append('g')

      var link = g.selectAll(".link"),
          node = g.selectAll(".node");

      var graph = {nodes: [], links: []};
      // Ignore operators
      var keys = Object.keys(DATA).filter(n => DATA[n].name.match(/^[a-zA-z]/));
      var moduleNames = {};
      keys.forEach((k, i) => {
        var item = DATA[k];
        moduleNames[item.moduleName] = true
        var node = {
          x: 50 * Math.cos(i / keys.length * Math.PI),
          y: 50 * Math.sin(i / keys.length * Math.PI),
          id: k,
          name: item.name,
          noDeps: item.values.length === 0,
          moduleName: item.moduleName,
        }
        // graph.nodes[k] = node;
        graph.nodes.push(node)
        DATA[k].values.forEach(({id, name, moduleName}) => {
          let pos = keys.indexOf(id)
          if (pos !== -1) {
            // graph.links.push({source: k, target: id})
            graph.links.push({source: i, target: pos})
          }
        })
      })
      let moduleList = Object.keys(moduleNames);

      var c20 = d3.scaleOrdinal(moduleList.length > 10 ? d3.schemeCategory20 : d3.schemeCategory10);

      var force = d3.forceSimulation()
            .force("charge", d3.forceManyBody().strength(-700).distanceMin(100).distanceMax(1000))
            .force("link", d3.forceLink().id(function(d) { return d.index }))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("y", d3.forceY(0.001))
            .force("x", d3.forceX(0.001))

      force
          .nodes(graph.nodes)
          .force('link').links(graph.links)

      link = link.data(graph.links)
        .enter()
      line = link.append("line")
          .attr("class", "link");
      dot = link.append("path").attr("class", "arrow");

      node = node.data(graph.nodes)
        .enter()
          .append("g")
          .attr("class", "node")
          .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));


      node.append('circle')
          .attr('r', 13)
          .attr('class', d => d.noDeps ? 'no-deps' : '')
          // .attr('stroke-width', d => d.noDeps ? 5 : 1)
          .attr('fill', function (d) {
            return c20(moduleList.indexOf(d.moduleName))
              // return color(d.group);
          });

      node.append("text")
          .attr('class', 'background')
          .attr("dx", -18)
          .attr("dy", 8)
          .text(d => d.name);

      node.append("text")
          .attr('class', 'foreground')
          .attr("dx", -18)
          .attr("dy", 8)
          .text(d => d.name);

      force.on("tick", function () { tick() });

      function zoomed() {
        g.attr("transform", d3.event.transform);
      }

      function tick() {
        dot.attr('d', d => {
          let dy = d.target.y - d.source.y;
          let dx = d.target.x - d.source.x;
          let dist = Math.sqrt(dx * dx + dy * dy)
          let theta = Math.atan2(dy, dx);
          // console.log(dy, dx, dist, theta)
          // fail
          let nx = Math.cos(theta) * (dist - 13) + d.source.x;
          let ny = Math.sin(theta) * (dist - 13) + d.source.y;
          let t1 = theta + Math.PI * 7 / 8;
          let t2 = theta - Math.PI * 7 / 8;
          let arrow = 10;
          return `M ${nx} ${ny} L ${nx + Math.cos(t1) * arrow}  ${ny + Math.sin(t1) * arrow} L ${nx + Math.cos(t2) * arrow} ${ny + Math.sin(t2)*arrow}`
          // return `translate(${nx}, ${ny})`
          // `translate(${d.target.x}, ${d.target.y})`
        });
        line.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node.attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
        });

        moduleList.forEach((n, i) => {
          var g = svg.append('g')
            .attr('transform', `translate(20, ${20 + i * 20})`)
          g.append('circle').attr('r', 10).attr('fill', c20(i))
          g.append('text').text(n)
          .attr('dx', 20)
          .attr('dy', 7)
        })
      }

      function dblclick(d) {
        d3.select(this).classed("fixed", d.fixed = false);
      }

      // function dragstart(d) {
      //   d3.select(this).classed("fixed", d.fixed = true);
      // }


              function dragstarted(d) {
            if (!d3.event.active) force.alphaTarget(0.5).restart();
            d.fx = d.x;
            d.fy = d.y;
        // d3.select(this).classed("fixed", d.fixed = true);
        location.hash = '#block-' + d.id
        }

        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }

        function dragended(d) {
            if (!d3.event.active) force.alphaTarget(0.5);
            d.fx = null;
            d.fy = null;
        }
    })();
  </script>
</body>